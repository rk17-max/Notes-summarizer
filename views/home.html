<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Notes App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. GLOBAL STYLES --- */
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --badge-bg: rgba(99, 102, 241, 0.2);
            --badge-text: #818cf8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 2rem; background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.25rem; font-weight: 700; color: white; }
        .logo span { color: var(--primary); }
        .nav-links { display: flex; gap: 2rem; }
        .nav-item { color: var(--text-muted); text-decoration: none; cursor: pointer; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { color: white; font-weight: 500; }
        .profile-icon {
            width: 35px; height: 35px; background: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }

        /* --- VIEWS --- */
        .view-section {
            display: none; padding: 2rem; flex: 1; overflow-y: auto;
            max-width: 1200px; margin: 0 auto; width: 100%;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UPLOAD SECTION --- */
        .upload-container {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 80%; text-align: center;
        }
        .upload-box {
            border: 2px dashed var(--text-muted); background: rgba(255,255,255,0.02);
            padding: 4rem; border-radius: 1rem; margin-top: 2rem; width: 100%; max-width: 600px;
            cursor: pointer; transition: 0.2s;
        }
        .upload-box:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }

        /* --- NOTES GRID (THEME UPDATE) --- */
        .notes-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem; margin-top: 1.5rem;
        }
        .note-card {
            background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; gap: 0.8rem;
            position: relative; overflow: hidden;
        }
        /* Add inside .note-card styles */
.note-card {
    /* ... existing styles ... */
    padding: 0; /* Remove padding so image touches edges */
    gap: 0;
}

.note-thumb {
    width: 100%;
    height: 150px; /* Fixed height for consistency */
    object-fit: cover;
    background-color: #2d3748; /* Placeholder color */
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.card-content {
    padding: 1.5rem; /* Re-add padding for the text part */
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    flex: 1;
}
        .note-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        
        .card-header { display: flex; justify-content: space-between; align-items: start; }
        .note-title { font-size: 1.1rem; font-weight: 600; color: #fff; line-height: 1.3; }
        .note-date { font-size: 0.75rem; color: var(--text-muted); }
        
        .badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .badge {
            font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 20px;
            background: var(--badge-bg); color: var(--badge-text); font-weight: 500;
        }
        .badge.course { background: rgba(16, 185, 129, 0.2); color: #34d399; } /* Green for course */

        .note-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .view-btn { font-size: 0.85rem; color: var(--primary); font-weight: 600; }

        /* --- MODAL FOR UPLOAD --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: var(--bg-card); padding: 2rem; border-radius: 1rem;
            width: 90%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1);
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-muted); }
        .form-input {
            width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; color: white;
        }
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 1rem;
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- PROFILE --- */
        .profile-card { background: var(--bg-card); padding: 2rem; border-radius: 1rem; max-width: 500px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Note<span>AI</span></div>
        <div class="nav-links">
            <a onclick="showView('home')" class="nav-item active" id="nav-home">Home</a>
            <a onclick="showView('notes')" class="nav-item" id="nav-notes">Notes Section</a>
            <a onclick="showView('profile')" class="nav-item" id="nav-profile">Profile</a>
        </div>
        <div class="profile-icon">?</div>
    </nav>

    <div class="modal-overlay" id="uploadModal">
        <div class="modal">
            <h2 style="margin-bottom: 1.5rem;">Upload Details</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="u-title" class="form-input" placeholder="e.g. Operating Systems Unit 1">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="u-desc" class="form-input" placeholder="Brief summary...">
            </div>
            <div class="form-group" style="display: flex; gap: 1rem;">
                <div style="flex:1">
                    <label>Subject</label>
                    <input type="text" id="u-subject" class="form-input" placeholder="e.g. CS">
                </div>
                <div style="flex:1">
                    <label>Course (Optional)</label>
                    <input type="text" id="u-course" class="form-input" placeholder="e.g. B.Tech">
                </div>
            </div>
            <p id="fileNameDisplay" style="font-size: 0.8rem; color: var(--primary); margin-bottom: 1rem;"></p>
            <button class="btn-primary" onclick="submitUpload()" id="uploadBtn">üöÄ Upload Note</button>
            <button onclick="closeModal()" style="background:none; border:none; color:var(--text-muted); margin-top:1rem; width:100%; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <section id="home-view" class="view-section active">
        <div class="upload-container">
            <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">What are we studying today?</h1>
            <p style="color: var(--text-muted);">Upload your PDF lecture notes to get started.</p>
            
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                <h3>Click to Upload PDF</h3>
                <p style="font-size: 0.8rem; color: var(--text-muted);">Max size 10MB</p>
                <input type="file" id="fileInput" accept="application/pdf" hidden onchange="handleFileSelect(this)">
            </div>
        </div>
    </section>

    <section id="notes-view" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Your Library</h2>
            <button onclick="showView('home')" style="font-size:0.9rem; color:var(--primary); background:none; border:none; cursor:pointer;">+ New Upload</button>
        </div>
        <div class="notes-grid" id="notesGrid">
            <p style="color:var(--text-muted);">Loading notes...</p>
        </div>
    </section>

    <section id="preview-view" class="view-section">
        <button onclick="showView('notes')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-bottom:1rem;">‚Üê Back to Notes</button>
        <div class="preview-header">
            <h1 id="previewTitle">Note Title</h1>
            <span id="previewDate" style="color: var(--text-muted);">Date</span>
        </div>
        <div class="preview-content" style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <div class="doc-viewer" style="flex:2; background: #fff; height: 500px; border-radius: 0.5rem; color:#333; display:flex; align-items:center; justify-content:center;">
                <p>PDF Viewer Coming Soon.<br>
                <a id="downloadLink" href="#" target="_blank" style="color:blue">Download PDF</a></p>
            </div>
            <div class="summary-panel" id="summaryPanel" style="flex:1; background: var(--bg-card); padding: 1.5rem; border-radius: 0.5rem; display:flex; flex-direction:column; max-height: 500px;">
    <h3>AI Actions</h3>
    
    <div id="summaryContent" style="flex:1; margin-top:1rem; overflow-y:auto; font-size:0.9rem; color:#e2e8f0; line-height:1.6; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
        <p style="color:var(--text-muted); font-style:italic;">Click the button below to generate a study summary.</p>
    </div>

    <button id="summaryBtn" class="btn-primary" onclick="requestSummary()" style="margin-top: 1rem;">‚ú® Generate Summary</button>
</div>
        </div>
    </section>

    <section id="profile-view" class="view-section">
        <h2>User Profile</h2>
        <div class="profile-card" style="margin-top: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                <div class="profile-icon" style="width: 80px; height: 80px; font-size: 2rem;">?</div>
                <div>
                    <h2 id="p-name">Loading...</h2>
                    <p id="p-email" style="color: var(--text-muted);">...</p>
                </div>
            </div>
            <div style="display: grid; gap: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                <div><span style="color: var(--text-muted); font-size: 0.9rem;">Student ID</span><p id="p-studentId">...</p></div>
                <div><span style="color: var(--text-muted); font-size: 0.9rem;">Department</span><p id="p-dept">...</p></div>
            </div>
        </div>
    </section>

<script>
    let selectedFile = null;

    
    function showView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById(viewName + '-view').classList.add('active');
        const navLink = document.getElementById('nav-' + viewName);
        if (navLink) navLink.classList.add('active');

        if (viewName === 'notes') fetchNotes(); // Refresh notes when clicking tab
        if (viewName === 'profile') loadProfile();
    }

    // --- 2. UPLOAD FLOW ---
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            selectedFile = input.files[0];
            document.getElementById('fileNameDisplay').innerText = "Selected: " + selectedFile.name;
            document.getElementById('uploadModal').style.display = 'flex'; // Show modal
        }
    }

    function closeModal() {
        document.getElementById('uploadModal').style.display = 'none';
        document.getElementById('fileInput').value = ""; // Reset input
    }

    async function submitUpload() {
        if (!selectedFile) return;

        const btn = document.getElementById('uploadBtn');
        btn.innerText = "Uploading...";
        btn.disabled = true;

        const formData = new FormData();
        formData.append('pdf', selectedFile);
        formData.append('title', document.getElementById('u-title').value);
        formData.append('description', document.getElementById('u-desc').value);
        formData.append('subject', document.getElementById('u-subject').value);
        formData.append('course', document.getElementById('u-course').value);

        try {
            const res = await fetch('/upload', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                alert("Upload Successful!");
                closeModal();
                showView('notes'); // Go to notes page
            } else {
                alert("Upload Failed: " + (data.error || "Unknown error"));
            }
        } catch (err) {
            console.error(err);
            alert("Error uploading file");
        } finally {
            btn.innerText = "üöÄ Upload Note";
            btn.disabled = false;
        }
    }

    
    function getThumbnailUrl(pdfUrl) {
        if (!pdfUrl) return 'https://via.placeholder.com/300x150?text=No+Preview';
        
      
        let thumbUrl = pdfUrl;
        
        if (thumbUrl.includes('cloudinary.com')) {
           
            thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,pg_1/');
            
            
            thumbUrl = thumbUrl.replace('.pdf', '.jpg');
            
            
            thumbUrl = thumbUrl.replace('/raw/', '/image/');
        }
        
        return thumbUrl;
    }

    async function fetchNotes() {
        const grid = document.getElementById('notesGrid');
        try {
            const res = await fetch('/notes'); 
            const data = await res.json();

            if (data.success && Array.isArray(data.notes) && data.notes.length > 0) {
                grid.innerHTML = ""; 
                data.notes.forEach(note => {
                    const date = new Date(note.createdAt).toLocaleDateString();
                    const thumb = getThumbnailUrl(note.fileUrl); // <--- GENERATE THUMBNAIL

                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.onclick = () => openPreview(note); 
                    
                    const courseBadge = note.course ? `<span class="badge course">${note.course}</span>` : '';
                    const subject = note.subject || 'General';

                    // üëá NEW CARD HTML WITH IMAGE ON TOP
                    card.innerHTML = `
                        <img src="${thumb}" class="note-thumb" alt="Note Preview" onerror="this.src='https://via.placeholder.com/300x150?text=PDF'">
                        
                        <div class="card-content">
                            <div class="card-header">
                                <div class="note-title">${note.title}</div>
                            </div>
                            <div class="badges">
                                <span class="badge">${subject}</span>
                                ${courseBadge}
                            </div>
                            <p class="note-desc">${note.description}</p>
                            <div class="card-footer">
                                <span class="note-date">${date}</span>
                                <span class="view-btn">View Note ‚Üí</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = "<p>No notes found. Upload one!</p>";
            }
        } catch (err) {
            console.error("Error fetching notes:", err);
        }
    }
    
    
    // 1. Add this variable at the very top of your script
    let currentNoteData = null; 

    // ... (existing showView, handleFileSelect, etc.) ...

    // 2. REPLACE your existing openPreview function with this:
    function openPreview(note) {
        currentNoteData = note; // Save note data for the API call
        
        document.getElementById('previewTitle').innerText = note.title;
        document.getElementById('previewDate').innerText = new Date(note.createdAt).toDateString();
        document.getElementById('downloadLink').href = note.fileUrl;
        
        // Reset the summary panel UI
        const summaryContent = document.getElementById('summaryContent');
        const summaryBtn = document.getElementById('summaryBtn');
        
        if(summaryContent) {
            summaryContent.innerHTML = '<p style="color:var(--text-muted); font-style:italic;">Click the button below to generate a study summary.</p>';
        }
        if(summaryBtn) {
            summaryBtn.disabled = false;
            summaryBtn.innerText = "‚ú® Generate Summary";
        }
        
        showView('preview');
    }

    // 3. ADD this new function for the API call
    async function requestSummary() {
        if (!currentNoteData) return;

        const summaryContent = document.getElementById('summaryContent');
        const btn = document.getElementById('summaryBtn');

        // Show Loading State
        btn.innerText = "Thinking...";
        btn.disabled = true;
        summaryContent.innerHTML = `
            <div style="text-align:center; padding:2rem; color:var(--primary);">
                <p>Reading your notes...</p>
                <p style="font-size:0.8rem; color:var(--text-muted);">This may take a few seconds.</p>
            </div>
        `;

        try {
            const res = await fetch('/summarize-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileUrl: currentNoteData.fileUrl })
            });

            const data = await res.json();

            if (data.success) {
                // Format the text (convert markdown bold to HTML)
                const formattedSummary = data.summary
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                summaryContent.innerHTML = formattedSummary;
                btn.innerText = "‚ú® Regenerate";
            } else {
                summaryContent.innerHTML = `<p style="color:red">Error: ${data.error}</p>`;
                btn.innerText = "Try Again";
            }
        } catch (err) {
            console.error(err);
            summaryContent.innerHTML = `<p style="color:red">Failed to connect to AI.</p>`;
            btn.innerText = "Try Again";
        } finally {
            btn.disabled = false;
        }
    }

    // --- 5. PROFILE ---
    async function loadProfile() {
        try {
            const res = await fetch('/profile');
            const data = await res.json();
            if (data.success) {
                const u = data.user;
                document.getElementById('p-name').innerText = `${u.firstName} ${u.lastName}`;
                document.getElementById('p-email').innerText = u.email;
                document.getElementById('p-studentId').innerText = u.studentId || "N/A";
                document.getElementById('p-dept').innerText = u.department || "General";
                document.querySelector('.profile-icon').innerText = u.firstName.charAt(0);
            }
        } catch (err) { console.error(err); }
    }

    // Initialize
    loadProfile();
</script>

</body>
</html>